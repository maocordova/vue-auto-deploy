# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Node.js CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  create-deployment-artifacts:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js 
      uses: actions/setup-node@v2
      with:
        node-version: 12.x

    - run: npm ci

    - run: npm run build --if-present

    - name: Create deployment artifact
      env:
        GITHUB_SHA: ${{ github.sha }}
      run: tar -czf "${GITHUB_SHA}".tar.gz dist

    - name: Store artifact for distribution
      uses: actions/upload-artifact@v2
      with:
        name: app-build
        path: ${{ github.sha }}.tar.gz

  prepare-release-on-servers:
      name: "Vue auto deploy: Prepare release"
      runs-on: ubuntu-latest
      needs: create-deployment-artifacts
      steps:
        - uses: actions/download-artifact@v2
          with:
            name: app-build

        - name: Upload to server
          uses: appleboy/scp-action@master
          with:
            host: ${{ secrets.SERVER_IP }}
            username: ${{ secrets.SERVER_USERNAME }}
            password: ${{ secrets.SERVER_PASSWORD }}
            port: ${{ secrets.SERVER_PORT }}
            source: ${{ github.sha }}.tar.gz
            target: ${{ secrets.SERVER_PATH }}/artifacts

        - name: Extract files and create directories
          uses: appleboy/ssh-action@master
          env:
            GITHUB_SHA: ${{ github.sha }}
          with:
            host: ${{ secrets.SERVER_IP }}
            username: ${{ secrets.SERVER_USERNAME }}
            password: ${{ secrets.SERVER_PASSWORD }}
            port: ${{ secrets.SERVER_PORT }}
            envs: GITHUB_SHA
            script: |
              # Extract the tar file into our release directory
              tar xzf ${{ secrets.SERVER_PATH }}/artifacts/${GITHUB_SHA}.tar.gz -C "${{ secrets.SERVER_PATH }}/"
